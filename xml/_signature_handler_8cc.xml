<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.13">
  <compounddef id="_signature_handler_8cc" kind="file" language="C++">
    <compoundname>SignatureHandler.cc</compoundname>
    <includes local="no">config.h</includes>
    <includes refid="_signature_handler_8h" local="yes">SignatureHandler.h</includes>
    <includes refid="gmem_8h" local="yes">goo/gmem.h</includes>
    <includes local="no">secmod.h</includes>
    <includes local="no">dirent.h</includes>
    <includes refid="_error_8h" local="no">Error.h</includes>
    <incdepgraph>
      <node id="89646">
        <label>stdarg.h</label>
      </node>
      <node id="89668">
        <label>openssl/opensslv.h</label>
        <link refid="opensslv_8h_source"/>
      </node>
      <node id="89686">
        <label>cryptohi.h</label>
      </node>
      <node id="89669">
        <label>stdint.h</label>
      </node>
      <node id="89674">
        <label>openssl/ec.h</label>
        <link refid="ec_8h_source"/>
        <childnode refid="89657" relation="include">
        </childnode>
        <childnode refid="89672" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89647">
        <label>stdlib.h</label>
      </node>
      <node id="89691">
        <label>goo/gmem.h</label>
        <link refid="gmem_8h_source"/>
        <childnode refid="89650" relation="include">
        </childnode>
        <childnode refid="89649" relation="include">
        </childnode>
      </node>
      <node id="89664">
        <label>openssl/bio.h</label>
        <link refid="bio_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89650" relation="include">
        </childnode>
        <childnode refid="89646" relation="include">
        </childnode>
        <childnode refid="89665" relation="include">
        </childnode>
        <childnode refid="89669" relation="include">
        </childnode>
      </node>
      <node id="89643">
        <label>SignatureHandler.h</label>
        <link refid="_signature_handler_8h_source"/>
        <childnode refid="89644" relation="include">
        </childnode>
        <childnode refid="89651" relation="include">
        </childnode>
        <childnode refid="89653" relation="include">
        </childnode>
        <childnode refid="89654" relation="include">
        </childnode>
        <childnode refid="89684" relation="include">
        </childnode>
        <childnode refid="89685" relation="include">
        </childnode>
        <childnode refid="89686" relation="include">
        </childnode>
        <childnode refid="89687" relation="include">
        </childnode>
        <childnode refid="89688" relation="include">
        </childnode>
        <childnode refid="89689" relation="include">
        </childnode>
        <childnode refid="89690" relation="include">
        </childnode>
      </node>
      <node id="89685">
        <label>cert.h</label>
      </node>
      <node id="89677">
        <label>openssl/rsa.h</label>
        <link refid="rsa_8h_source"/>
        <childnode refid="89672" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89665" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89659">
        <label>openssl/buffer.h</label>
        <link refid="buffer_8h_source"/>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89661" relation="include">
        </childnode>
        <childnode refid="89662" relation="include">
        </childnode>
      </node>
      <node id="89666">
        <label>openssl/stack.h</label>
        <link refid="stack_8h_source"/>
      </node>
      <node id="89692">
        <label>secmod.h</label>
      </node>
      <node id="89694">
        <label>Error.h</label>
        <link refid="_error_8h_source"/>
        <childnode refid="89646" relation="include">
        </childnode>
        <childnode refid="89649" relation="include">
        </childnode>
        <childnode refid="89648" relation="include">
        </childnode>
        <childnode refid="89644" relation="include">
        </childnode>
      </node>
      <node id="89683">
        <label>openssl/pkcs7.h</label>
        <link refid="pkcs7_8h_source"/>
        <childnode refid="89672" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
      </node>
      <node id="89689">
        <label>secmodt.h</label>
      </node>
      <node id="89653">
        <label>nspr.h</label>
      </node>
      <node id="89661">
        <label>stddef.h</label>
      </node>
      <node id="89680">
        <label>openssl/sha.h</label>
        <link refid="sha_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89661" relation="include">
        </childnode>
      </node>
      <node id="89673">
        <label>openssl/bn.h</label>
        <link refid="bn_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89650" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89665" relation="include">
        </childnode>
      </node>
      <node id="89645">
        <label>limits.h</label>
      </node>
      <node id="89655">
        <label>openssl/x509.h</label>
        <link refid="x509_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
        <childnode refid="89659" relation="include">
        </childnode>
        <childnode refid="89663" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89666" relation="include">
        </childnode>
        <childnode refid="89672" relation="include">
        </childnode>
        <childnode refid="89667" relation="include">
        </childnode>
        <childnode refid="89674" relation="include">
        </childnode>
        <childnode refid="89675" relation="include">
        </childnode>
        <childnode refid="89676" relation="include">
        </childnode>
        <childnode refid="89677" relation="include">
        </childnode>
        <childnode refid="89678" relation="include">
        </childnode>
        <childnode refid="89679" relation="include">
        </childnode>
        <childnode refid="89680" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89681" relation="include">
        </childnode>
        <childnode refid="89683" relation="include">
        </childnode>
      </node>
      <node id="89687">
        <label>secerr.h</label>
      </node>
      <node id="89649">
        <label>poppler-config.h</label>
        <link refid="poppler-config_8h_source"/>
        <childnode refid="89650" relation="include">
        </childnode>
      </node>
      <node id="89678">
        <label>openssl/dsa.h</label>
        <link refid="dsa_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89665" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
        <childnode refid="89679" relation="include">
        </childnode>
      </node>
      <node id="89671">
        <label>openssl/obj_mac.h</label>
        <link refid="obj__mac_8h_source"/>
      </node>
      <node id="89651">
        <label>SignatureInfo.h</label>
        <link refid="_signature_info_8h_source"/>
        <childnode refid="89652" relation="include">
        </childnode>
      </node>
      <node id="89684">
        <label>nss.h</label>
      </node>
      <node id="89681">
        <label>openssl/x509_vfy.h</label>
        <link refid="x509__vfy_8h_source"/>
        <childnode refid="89655" relation="include">
        </childnode>
        <childnode refid="89657" relation="include">
        </childnode>
        <childnode refid="89682" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89665" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
      </node>
      <node id="89662">
        <label>sys/types.h</label>
      </node>
      <node id="89644">
        <label>goo/GooString.h</label>
        <link refid="_goo_string_8h_source"/>
        <childnode refid="89645" relation="include">
        </childnode>
        <childnode refid="89646" relation="include">
        </childnode>
        <childnode refid="89647" relation="include">
        </childnode>
        <childnode refid="89648" relation="include">
        </childnode>
      </node>
      <node id="89658">
        <label>openssl/symhacks.h</label>
        <link refid="symhacks_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
      </node>
      <node id="89672">
        <label>openssl/asn1.h</label>
        <link refid="asn1_8h_source"/>
        <childnode refid="89652" relation="include">
        </childnode>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89666" relation="include">
        </childnode>
        <childnode refid="89667" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89667">
        <label>openssl/safestack.h</label>
        <link refid="safestack_8h_source"/>
        <childnode refid="89666" relation="include">
        </childnode>
      </node>
      <node id="89663">
        <label>openssl/evp.h</label>
        <link refid="evp_8h_source"/>
        <childnode refid="89657" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89670" relation="include">
        </childnode>
      </node>
      <node id="89652">
        <label>time.h</label>
      </node>
      <node id="89675">
        <label>openssl/ecdsa.h</label>
        <link refid="ecdsa_8h_source"/>
        <childnode refid="89657" relation="include">
        </childnode>
        <childnode refid="89674" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89682">
        <label>openssl/lhash.h</label>
        <link refid="lhash_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89650" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
      </node>
      <node id="89648">
        <label>gtypes.h</label>
        <link refid="gtypes_8h_source"/>
        <childnode refid="89649" relation="include">
        </childnode>
      </node>
      <node id="89654">
        <label>cms.h</label>
        <link refid="cms_8h_source"/>
        <childnode refid="89655" relation="include">
        </childnode>
      </node>
      <node id="89670">
        <label>openssl/objects.h</label>
        <link refid="objects_8h_source"/>
        <childnode refid="89671" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89672" relation="include">
        </childnode>
      </node>
      <node id="89657">
        <label>openssl/opensslconf.h</label>
        <link refid="opensslconf_8h_source"/>
      </node>
      <node id="89688">
        <label>secoid.h</label>
      </node>
      <node id="89642">
        <label>config.h</label>
      </node>
      <node id="89656">
        <label>openssl/e_os2.h</label>
        <link refid="e__os2_8h_source"/>
        <childnode refid="89657" relation="include">
        </childnode>
      </node>
      <node id="89690">
        <label>sechash.h</label>
      </node>
      <node id="89650">
        <label>stdio.h</label>
      </node>
      <node id="89676">
        <label>openssl/ecdh.h</label>
        <link refid="ecdh_8h_source"/>
        <childnode refid="89657" relation="include">
        </childnode>
        <childnode refid="89674" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89641">
        <label>thirdparty/poppler/poppler/SignatureHandler.cc</label>
        <link refid="_signature_handler_8cc"/>
        <childnode refid="89642" relation="include">
        </childnode>
        <childnode refid="89643" relation="include">
        </childnode>
        <childnode refid="89691" relation="include">
        </childnode>
        <childnode refid="89692" relation="include">
        </childnode>
        <childnode refid="89693" relation="include">
        </childnode>
        <childnode refid="89694" relation="include">
        </childnode>
      </node>
      <node id="89660">
        <label>openssl/ossl_typ.h</label>
        <link refid="ossl__typ_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
      </node>
      <node id="89665">
        <label>openssl/crypto.h</label>
        <link refid="crypto_8h_source"/>
        <childnode refid="89647" relation="include">
        </childnode>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89650" relation="include">
        </childnode>
        <childnode refid="89666" relation="include">
        </childnode>
        <childnode refid="89667" relation="include">
        </childnode>
        <childnode refid="89668" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89658" relation="include">
        </childnode>
      </node>
      <node id="89679">
        <label>openssl/dh.h</label>
        <link refid="dh_8h_source"/>
        <childnode refid="89656" relation="include">
        </childnode>
        <childnode refid="89664" relation="include">
        </childnode>
        <childnode refid="89660" relation="include">
        </childnode>
        <childnode refid="89673" relation="include">
        </childnode>
      </node>
      <node id="89693">
        <label>dirent.h</label>
      </node>
    </incdepgraph>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">//========================================================================</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="comment">//<sp/>SignatureHandler.cc</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="comment">//<sp/>This<sp/>file<sp/>is<sp/>licensed<sp/>under<sp/>the<sp/>GPLv2<sp/>or<sp/>later</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>2015,<sp/>2016<sp/>André<sp/>Guerreiro<sp/>&lt;aguerreiro1985@gmail.com&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>2015<sp/>André<sp/>Esser<sp/>&lt;bepandre@hotmail.com&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>2015,<sp/>2016<sp/>Albert<sp/>Astals<sp/>Cid<sp/>&lt;aacid@kde.org&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="comment">//<sp/>Copyright<sp/>2015<sp/>Markus<sp/>Kilås<sp/>&lt;digital@markuspage.com&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="comment">//</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="comment">//========================================================================</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;config.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;SignatureHandler.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;goo/gmem.h&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;secmod.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;dirent.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;Error.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>SignatureHandler::digestLength(SECOidTag<sp/>digestAlgId)</highlight></codeline>
<codeline lineno="24"><highlight class="normal">{</highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(digestAlgId){</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_OID_SHA1:</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>20;</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_OID_SHA256:</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>32;</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_OID_SHA384:</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>48;</highlight></codeline>
<codeline lineno="32"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_OID_SHA512:</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>64;</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;ERROR:<sp/>Unrecognized<sp/>Hash<sp/>ID\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="38"><highlight class="normal">}</highlight></codeline>
<codeline lineno="39"><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*SignatureHandler::getSignerName()</highlight></codeline>
<codeline lineno="41"><highlight class="normal">{</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CMSSignerInfo)</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="44"><highlight class="normal"></highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/>CERTCertificate<sp/>*cert<sp/>=<sp/>NSS_CMSSignerInfo_GetSigningCertificate(CMSSignerInfo,<sp/>CERT_GetDefaultCertDB());</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERT_GetCommonName(&amp;cert-&gt;subject);</highlight></codeline>
<codeline lineno="47"><highlight class="normal">}</highlight></codeline>
<codeline lineno="48"><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal">time_t<sp/>SignatureHandler::getSigningTime()</highlight></codeline>
<codeline lineno="50"><highlight class="normal">{</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/>PRTime<sp/>sTime;<sp/></highlight><highlight class="comment">//<sp/>time<sp/>in<sp/>microseconds<sp/>since<sp/>the<sp/>epoch</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(NSS_CMSSignerInfo_GetSigningTime<sp/>(CMSSignerInfo,<sp/>&amp;sTime)<sp/>!=<sp/>SECSuccess)</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0;</highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(time_t)<sp/>sTime/1000000;</highlight></codeline>
<codeline lineno="57"><highlight class="normal">}</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><ref refid="class_goo_string" kindref="compound">GooString</ref><sp/>*SignatureHandler::getDefaultFirefoxCertDB_Linux()</highlight></codeline>
<codeline lineno="61"><highlight class="normal">{</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><ref refid="class_goo_string" kindref="compound">GooString</ref><sp/>*<sp/>finalPath<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/>DIR<sp/>*toSearchIn;</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">dirent<sp/>*subFolder;</highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><ref refid="class_goo_string" kindref="compound">GooString</ref><sp/>*<sp/>homePath<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="class_goo_string" kindref="compound">GooString</ref>(getenv(</highlight><highlight class="stringliteral">&quot;HOME&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/>homePath<sp/>=<sp/>homePath-&gt;append(</highlight><highlight class="stringliteral">&quot;/.mozilla/firefox/&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((toSearchIn<sp/>=<sp/>opendir(homePath-&gt;getCString()))<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/>error(errInternal,<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;couldn&apos;t<sp/>find<sp/>default<sp/>Firefox<sp/>Folder&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>homePath;</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((subFolder<sp/>=<sp/>readdir(toSearchIn))<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(strstr(subFolder-&gt;d_name,<sp/></highlight><highlight class="stringliteral">&quot;default&quot;</highlight><highlight class="normal">)<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>finalPath<sp/>=<sp/>homePath-&gt;append(subFolder-&gt;d_name);</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>closedir(toSearchIn);</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>finalPath;</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/>(subFolder<sp/>!=<sp/>NULL);</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/>closedir(toSearchIn);</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>homePath;</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="87"><highlight class="normal">}</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SignatureHandler::init_nss()<sp/></highlight></codeline>
<codeline lineno="93"><highlight class="normal">{</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><ref refid="class_goo_string" kindref="compound">GooString</ref><sp/>*certDBPath<sp/>=<sp/>getDefaultFirefoxCertDB_Linux();</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(certDBPath<sp/>==<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/>NSS_Init(</highlight><highlight class="stringliteral">&quot;sql:/etc/pki/nssdb&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/>NSS_Init(certDBPath-&gt;getCString());</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//Make<sp/>sure<sp/>NSS<sp/>root<sp/>certificates<sp/>module<sp/>is<sp/>loaded</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/>SECMOD_AddNewModule(</highlight><highlight class="stringliteral">&quot;Root<sp/>Certs&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;libnssckbi.so&quot;</highlight><highlight class="normal">,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">delete</highlight><highlight class="normal"><sp/>certDBPath;</highlight></codeline>
<codeline lineno="104"><highlight class="normal">}</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal">SignatureHandler::SignatureHandler(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*p7,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>p7_length)</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/>:<sp/>CMSMessage(NULL),</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/>CMSSignedData(NULL),</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/>CMSSignerInfo(NULL),</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/>temp_certs(NULL)</highlight></codeline>
<codeline lineno="112"><highlight class="normal">{</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/>init_nss();</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/>CMSitem.data<sp/>=<sp/>p7;</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/>CMSitem.len<sp/>=<sp/>p7_length;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/>CMSMessage<sp/>=<sp/>CMS_MessageCreate(&amp;CMSitem);</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/>CMSSignedData<sp/>=<sp/>CMS_SignedDataCreate(CMSMessage);</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/>CMSSignerInfo<sp/>=<sp/>CMS_SignerInfoCreate(CMSSignedData);</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/>hash_context<sp/>=<sp/>initHashContext();</highlight></codeline>
<codeline lineno="120"><highlight class="normal">}</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal">HASHContext<sp/>*<sp/>SignatureHandler::initHashContext()</highlight></codeline>
<codeline lineno="123"><highlight class="normal">{</highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/>SECItem<sp/>usedAlgorithm<sp/>=<sp/>NSS_CMSSignedData_GetDigestAlgs(CMSSignedData)[0]-&gt;algorithm;</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/>hash_length<sp/>=<sp/>digestLength(SECOID_FindOIDTag(&amp;usedAlgorithm));</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/>HASH_HashType<sp/>hashType;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/>hashType<sp/><sp/><sp/><sp/>=<sp/>HASH_GetHashTypeByOidTag(SECOID_FindOIDTag(&amp;usedAlgorithm));</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>HASH_Create(hashType);</highlight></codeline>
<codeline lineno="130"><highlight class="normal">}</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>SignatureHandler::updateHash(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<sp/>data_block,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>data_len)</highlight></codeline>
<codeline lineno="133"><highlight class="normal">{</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/>HASH_Update(hash_context,<sp/>data_block,<sp/>data_len);</highlight></codeline>
<codeline lineno="135"><highlight class="normal">}</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal">SignatureHandler::~SignatureHandler()</highlight></codeline>
<codeline lineno="138"><highlight class="normal">{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/>SECITEM_FreeItem(&amp;CMSitem,<sp/>PR_FALSE);</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CMSSignerInfo)</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/>NSS_CMSSignerInfo_Destroy(CMSSignerInfo);</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CMSSignedData)</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>NSS_CMSSignedData_Destroy(CMSSignedData);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(CMSMessage)</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/>NSS_CMSMessage_Destroy(CMSMessage);</highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(hash_context)</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/>HASH_Destroy(hash_context);</highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/>free(temp_certs);</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(NSS_Shutdown()!=SECSuccess)</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/>fprintf(stderr,<sp/></highlight><highlight class="stringliteral">&quot;Detail:<sp/>%s\n&quot;</highlight><highlight class="normal">,<sp/>PR_ErrorToString(PORT_GetError(),<sp/>PR_LANGUAGE_I_DEFAULT));</highlight></codeline>
<codeline lineno="154"><highlight class="normal">}</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal">NSSCMSMessage<sp/>*SignatureHandler::CMS_MessageCreate(SECItem<sp/>*<sp/>cms_item)</highlight></codeline>
<codeline lineno="157"><highlight class="normal">{</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cms_item-&gt;data){</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NSS_CMSMessage_CreateFromDER(cms_item,<sp/>NULL,<sp/>NULL<sp/></highlight><highlight class="comment">/*<sp/>Content<sp/>callback<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,<sp/>NULL,<sp/>NULL<sp/></highlight><highlight class="comment">/*Password<sp/>callback*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>,<sp/>NULL,<sp/>NULL<sp/></highlight><highlight class="comment">/*Decrypt<sp/>callback*/</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="165"><highlight class="normal">}</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="167"><highlight class="normal">NSSCMSSignedData<sp/>*SignatureHandler::CMS_SignedDataCreate(NSSCMSMessage<sp/>*<sp/>cms_msg)</highlight></codeline>
<codeline lineno="168"><highlight class="normal">{</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!NSS_CMSMessage_IsSigned(cms_msg))<sp/>{</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/>error(errInternal,<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Input<sp/>couldn&apos;t<sp/>be<sp/>parsed<sp/>as<sp/>a<sp/>CMS<sp/>signature&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/>NSSCMSContentInfo<sp/>*cinfo<sp/>=<sp/>NSS_CMSMessage_ContentLevel(cms_msg,<sp/>0);</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!cinfo)<sp/>{</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/>error(errInternal,<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;Error<sp/>in<sp/>NSS_CMSMessage_ContentLevel&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/>NSSCMSSignedData<sp/>*signedData<sp/>=<sp/>(NSSCMSSignedData*)<sp/>NSS_CMSContentInfo_GetContent(cinfo);</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!signedData)<sp/>{</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/>error(errInternal,<sp/>0,<sp/></highlight><highlight class="stringliteral">&quot;CError<sp/>in<sp/>NSS_CMSContentInfo_GetContent()&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(signedData-&gt;rawCerts)</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>i;</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>signedData-&gt;rawCerts[i];<sp/>++i)<sp/>{}<sp/></highlight><highlight class="comment">//<sp/>just<sp/>count<sp/>the<sp/>length<sp/>of<sp/>the<sp/>certificate<sp/>chain</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>tempCerts<sp/>field<sp/>needs<sp/>to<sp/>be<sp/>filled<sp/>for<sp/>complete<sp/>memory<sp/>release<sp/>by<sp/>NSSCMSSignedData_Destroy</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/>signedData-&gt;tempCerts<sp/>=<sp/>(CERTCertificate<sp/>**)<sp/>gmallocn(<sp/>i+1,<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(CERTCertificate<sp/>*));</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>memset(signedData-&gt;tempCerts,<sp/>0,<sp/>(i+1)<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(CERTCertificate<sp/>*));</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>store<sp/>the<sp/>adresses<sp/>of<sp/>these<sp/>temporary<sp/>certificates<sp/>for<sp/>future<sp/>release</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(i<sp/>=<sp/>0;<sp/>signedData-&gt;rawCerts[i];<sp/>++i)</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>signedData-&gt;tempCerts[i]<sp/>=<sp/>CERT_NewTempCertificate(CERT_GetDefaultCertDB(),<sp/>signedData-&gt;rawCerts[i],<sp/>NULL,<sp/>0,<sp/>0);</highlight></codeline>
<codeline lineno="197"><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/>temp_certs<sp/>=<sp/>signedData-&gt;tempCerts;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>signedData;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="203"><highlight class="normal">}</highlight></codeline>
<codeline lineno="204"><highlight class="normal"></highlight></codeline>
<codeline lineno="205"><highlight class="normal">NSSCMSSignerInfo<sp/>*SignatureHandler::CMS_SignerInfoCreate(NSSCMSSignedData<sp/>*<sp/>cms_sig_data)</highlight></codeline>
<codeline lineno="206"><highlight class="normal">{</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/>NSSCMSSignerInfo<sp/>*signerInfo<sp/>=<sp/>NSS_CMSSignedData_GetSignerInfo(cms_sig_data,<sp/>0);</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!signerInfo)<sp/>{</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/>printf(</highlight><highlight class="stringliteral">&quot;Error<sp/>in<sp/>NSS_CMSSignedData_GetSignerInfo()\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NULL;</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>signerInfo;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="214"><highlight class="normal">}</highlight></codeline>
<codeline lineno="215"><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal">NSSCMSVerificationStatus<sp/>SignatureHandler::validateSignature()</highlight></codeline>
<codeline lineno="217"><highlight class="normal">{</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*digest_buffer<sp/>=<sp/>NULL;</highlight></codeline>
<codeline lineno="219"><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CMSSignedData)</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NSSCMSVS_MalformedSignature;</highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/>digest_buffer<sp/>=<sp/>(</highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*)PORT_Alloc(hash_length);</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">unsigned</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>result_len<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="225"><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/>HASH_End(hash_context,<sp/>digest_buffer,<sp/>&amp;result_len,<sp/>hash_length);</highlight></codeline>
<codeline lineno="227"><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/>SECItem<sp/>digest;</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/>digest.data<sp/>=<sp/>digest_buffer;</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/>digest.len<sp/>=<sp/>hash_length;</highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((NSS_CMSSignerInfo_GetSigningCertificate(CMSSignerInfo,<sp/>CERT_GetDefaultCertDB()))<sp/>==<sp/>NULL)</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/>CMSSignerInfo-&gt;verificationStatus<sp/>=<sp/>NSSCMSVS_SigningCertNotFound;</highlight></codeline>
<codeline lineno="234"><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/>SECItem<sp/>*<sp/>content_info_data<sp/>=<sp/>CMSSignedData-&gt;contentInfo.content.data;</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(content_info_data<sp/>!=<sp/>NULL<sp/>&amp;&amp;<sp/>content_info_data-&gt;data<sp/>!=<sp/>NULL)</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*</highlight></codeline>
<codeline lineno="239"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/>This<sp/>means<sp/>it&apos;s<sp/>not<sp/>a<sp/>detached<sp/>type<sp/>signature</highlight></codeline>
<codeline lineno="240"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/>so<sp/>the<sp/>digest<sp/>is<sp/>contained<sp/>in<sp/>SignedData-&gt;contentInfo</highlight></codeline>
<codeline lineno="241"><highlight class="comment"><sp/><sp/><sp/><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(memcmp(digest.data,<sp/>content_info_data-&gt;data,<sp/>hash_length)<sp/>==<sp/>0</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>digest.len<sp/>==<sp/>content_info_data-&gt;len)</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>PORT_Free(digest_buffer);</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NSSCMSVS_GoodSignature;</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>PORT_Free(digest_buffer);</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NSSCMSVS_DigestMismatch;</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="253"><highlight class="normal"></highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(NSS_CMSSignerInfo_Verify(CMSSignerInfo,<sp/>&amp;digest,<sp/>NULL)<sp/>!=<sp/>SECSuccess)</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/>PORT_Free(digest_buffer);</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CMSSignerInfo-&gt;verificationStatus;</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/>PORT_Free(digest_buffer);</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>NSSCMSVS_GoodSignature;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="266"><highlight class="normal">}</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal">SECErrorCodes<sp/>SignatureHandler::validateCertificate()</highlight></codeline>
<codeline lineno="269"><highlight class="normal">{</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/>SECErrorCodes<sp/>retVal;</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/>CERTCertificate<sp/>*cert;</highlight></codeline>
<codeline lineno="272"><highlight class="normal"></highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(!CMSSignerInfo)</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(SECErrorCodes)<sp/>-1;<sp/></highlight><highlight class="comment">//error<sp/>code<sp/>to<sp/>avoid<sp/>matching<sp/>error<sp/>codes<sp/>defined<sp/>in<sp/>SECErrorCodes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>((cert<sp/>=<sp/>NSS_CMSSignerInfo_GetSigningCertificate(CMSSignerInfo,<sp/>CERT_GetDefaultCertDB()))<sp/>==<sp/>NULL)</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/>CMSSignerInfo-&gt;verificationStatus<sp/>=<sp/>NSSCMSVS_SigningCertNotFound;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/>CERTValInParam<sp/>inParams[2];</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/>inParams[0].type<sp/>=<sp/>cert_pi_revocationFlags;</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/>inParams[0].value.pointer.revocation<sp/>=<sp/>CERT_GetClassicOCSPEnabledSoftFailurePolicy();</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/>inParams[1].type<sp/>=<sp/>cert_pi_end;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/>CERT_PKIXVerifyCert(cert,<sp/>certificateUsageEmailSigner,<sp/>inParams,<sp/>NULL,</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CMSSignerInfo-&gt;cmsg-&gt;pwfn_arg);</highlight></codeline>
<codeline lineno="286"><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/>retVal<sp/>=<sp/>(SECErrorCodes)<sp/>PORT_GetError();</highlight></codeline>
<codeline lineno="288"><highlight class="normal"></highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(cert)</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/>CERT_DestroyCertificate(cert);</highlight></codeline>
<codeline lineno="291"><highlight class="normal"></highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>retVal;</highlight></codeline>
<codeline lineno="293"><highlight class="normal">}</highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal">SignatureValidationStatus<sp/>SignatureHandler::NSS_SigTranslate(NSSCMSVerificationStatus<sp/>nss_code)</highlight></codeline>
<codeline lineno="297"><highlight class="normal">{</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(nss_code)</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>NSSCMSVS_GoodSignature:</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SIGNATURE_VALID;</highlight></codeline>
<codeline lineno="302"><highlight class="normal"></highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>NSSCMSVS_BadSignature:</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SIGNATURE_INVALID;</highlight></codeline>
<codeline lineno="305"><highlight class="normal"></highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>NSSCMSVS_DigestMismatch:</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SIGNATURE_DIGEST_MISMATCH;</highlight></codeline>
<codeline lineno="308"><highlight class="normal"></highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>NSSCMSVS_ProcessingError:</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SIGNATURE_DECODING_ERROR;</highlight></codeline>
<codeline lineno="311"><highlight class="normal"></highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>SIGNATURE_GENERIC_ERROR;</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="315"><highlight class="normal">}</highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal">CertificateValidationStatus<sp/>SignatureHandler::NSS_CertTranslate(SECErrorCodes<sp/>nss_code)</highlight></codeline>
<codeline lineno="318"><highlight class="normal">{</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//<sp/>0<sp/>not<sp/>defined<sp/>in<sp/>SECErrorCodes,<sp/>it<sp/>means<sp/>success<sp/>for<sp/>this<sp/>purpose.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(nss_code<sp/>==<sp/>(SECErrorCodes)<sp/>0)</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_TRUSTED;</highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">switch</highlight><highlight class="normal">(nss_code)</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/>{</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_ERROR_UNKNOWN_ISSUER:</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_UNKNOWN_ISSUER;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_ERROR_UNTRUSTED_ISSUER:</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_UNTRUSTED_ISSUER;</highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_ERROR_REVOKED_CERTIFICATE:</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_REVOKED;</highlight></codeline>
<codeline lineno="333"><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">case</highlight><highlight class="normal"><sp/>SEC_ERROR_EXPIRED_CERTIFICATE:</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_EXPIRED;</highlight></codeline>
<codeline lineno="336"><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">default</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>CERTIFICATE_GENERIC_ERROR;</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="340"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="thirdparty/poppler/poppler/SignatureHandler.cc"/>
  </compounddef>
</doxygen>
